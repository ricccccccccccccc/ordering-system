<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/img/ico.ico" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Use Jquery for ajax request -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>Food Ordering System</title>
  </head>
  <body>
    <!-- Optional JavaScript; choose one of the two! -->
    <div class="container">
      <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
            <button class="navbar-brand font-fam" type="button"><img src="assets/img/foodmanda.png" class="img-fluid rounded-start m-r" alt="...">Food Mandin</button>
          </div>
        </div>
      </nav>
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-cart4 svg-s" viewBox="0 0 16 16">
          <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
        </svg>
      Order Cart</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col"></th>
            <th scope="col">Order Dish</th>
            <th scope="col">Price</th>
            <th scope="col" width="10%">Qty</th>
            <th scope="col">SubTotal</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody class="t-body">
          
        </tbody>
      </table>
      <div class="row g-0">
        <div class="col-sm-6 col-md-8"><button class="saa" onClick="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-compact-left chev" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M9.224 1.553a.5.5 0 0 1 .223.67L6.56 8l2.888 5.776a.5.5 0 1 1-.894.448l-3-6a.5.5 0 0 1 0-.448l3-6a.5.5 0 0 1 .67-.223"/>
          </svg>
        Continue Ordering</button></div>
        <div class="col-6 col-md-2"><strong><p class="m-ts">Total: <span id="total">0.00</span></p></strong></div>
        <div class="col-6 col-md-2 text-end"><button class="saaa">Check Out
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-compact-right chev" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6.776 1.553a.5.5 0 0 1 .671.223l3 6a.5.5 0 0 1 0 .448l-3 6a.5.5 0 1 1-.894-.448L9.44 8 6.553 2.224a.5.5 0 0 1 .223-.671"/>
          </svg>
        </button></div>
      </div>
    </div>
     <footer class="custom-footer">
      <ul class="nav justify-content-center border-bottom pb-3 mb-3">
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Home</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Features</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Pricing</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">FAQs</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">About</a></li>
      </ul>
      <p class="text-center text-muted">Â© 2022 Company, Inc</p>
    </footer>
    </div>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
  </body>
  <script type="text/javascript">
    function goBack() {   
              window.location.href = "http://localhost/orderingapp/";
             // window.history.back();
                }

    $(document).ready(function() {
          //fetch record.
          $.ajax({
              url: "f_file_log/",
              type: "GET",
              dataType: "json",
              success: function(t) {
                  // Handle success
                  var e = $(".t-body");
                  if (t.length === 0) {
                     e.append('<tr><td colspan="6" class="nrf">No order yet</td></tr>');
                  }else{
                  $.each(t, (function(t, a) {
                  var d = 
                  `<tr>\n          
                  <td><img src="${a.img}" alt="Product Image" class="img-fluid i-w"></td>\n          
                  <td class="res">${a.prodtitle}</td>\n                    
                  <td class="res price">${a.prodprice}</td>\n 
                  <td>
                    <div class="input-group quantity-input-group">
                      <button class="btn btn-outline-secondary decrement-btn" type="button">-</button>
                      <input type="text" class="form-control qty-input text-center" value="0" min="1"">
                      <button class="btn btn-outline-secondary increment-btn" type="button">+</button>
                    </div>
                  </td>\n   
                  <td class="subtotal"></td>\n                           
                  <td><button class="btn btn-danger delete-button" data-record-id="${a.ID}">
                      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                      </svg>
                  </button></td>\n                
                  </tr>`;
                  e.append(d);
                }))
                }
              },
              error: function(xhr, status, error) {
                  // Handle error
                  console.error('Error adding product to cart:', status, error);
              }
          });
          //delete record.
          $(document).on("click", ".delete-button", (function() {
              var t = $(this).data("record-id");
              $.ajax({
                url: "d_file_log/",
                type: "POST",
                data: {
                  id: t
                },
                success: function(t) {
                  alert('Record Deleted.');
                  window.location.href = "http://localhost/orderingapp/pages/order-cart/";
                },
                error: function(t) {
                  console.error("Error:", t)
                }
              })
            }))
          //update total.
          function updateTotal() {
              let total = 0;
                document.querySelectorAll('.subtotal').forEach(subtotalElement => {
                  const subtotal = parseFloat(subtotalElement.textContent);
                  if (!isNaN(subtotal)) {
                    total += subtotal;
                  }
                });
                document.getElementById('total').textContent = total.toFixed(2);
            }
          //increment - decrement
          document.addEventListener('click', function(event) {
              if (event.target.matches('.increment-btn') || event.target.matches('.decrement-btn')) {
                const inputGroup = event.target.closest('.quantity-input-group');
                const input = inputGroup.querySelector('.qty-input');
                let quantity = parseInt(input.value, 10);

                if (event.target.matches('.increment-btn')) {
                  quantity += 1;
                } else if (event.target.matches('.decrement-btn')) {
                  if (quantity > 1) {
                    quantity -= 1;
                  }
                }

                input.value = quantity;

                // Update the subtotal
                const row = event.target.closest('tr');
                const priceElement = row.querySelector('.price');
                const price = parseFloat(priceElement.textContent.replace(/[^\d.-]/g, '')); // Strip out any non-numeric characters
                const subtotalElement = row.querySelector('.subtotal');
                subtotalElement.textContent = (price * quantity).toFixed(2);
                // Update the total
                updateTotal();
              }
            });
            //update subtotal
            document.addEventListener('input', function(event) {
              if (event.target.matches('.qty-input')) {
                const input = event.target;
                let quantity = parseInt(input.value, 10);
                
                // Ensure minimum value of 1
                if (isNaN(quantity) || quantity < 1) {
                  quantity = 1;
                  input.value = 1;
                }

                // Update the subtotal
                const row = input.closest('tr');
                const priceElement = row.querySelector('.price');
                const price = parseFloat(priceElement.textContent.replace(/[^\d.-]/g, '')); // Strip out any non-numeric characters
                const subtotalElement = row.querySelector('.subtotal');
                subtotalElement.textContent = (price * quantity).toFixed(2);
                // Update the total
                updateTotal();
              }
            });
            // Update the total
            updateTotal();

            // Function to update the "Check Out" button based on the total
                function updateCheckoutButton(total) {
                    if (total === 0.00) {
                        // If total is 0.00, disable the button
                        $('.saaa').prop('disabled', true);
                    } else {
                        // Otherwise, enable the button
                        $('.saaa').prop('disabled', false);
                    }
                }

                // Initially, update the "Check Out" button based on the total
                updateCheckoutButton(parseFloat($('#total').text()));

                // Event listener for changes in total
                $('#total').bind('DOMSubtreeModified', function() {
                    var total = parseFloat($(this).text());
                    // Update the "Check Out" button based on the updated total
                    updateCheckoutButton(total);
                });

              });

            function updateDatabase(recordId, quantity, subtotal) {
                // Make an AJAX call to update the database with the new quantity and subtotal
                $.ajax({
                    url: "u_file_log/", // Change the URL to your server endpoint for updating records
                    type: "POST",
                    data: {
                        ID: recordId,
                        qty: quantity,
                        subtotal: subtotal
                    },
                    success: function(response) {
                        console.log('Record updated:', response);
                        window.location.href = "http://localhost/orderingapp/pages/order-prev/";
                    },
                    error: function(xhr, status, error) {
                        console.error('Error updating record:', status, error);
                    }
                });
            }


             $('.saaa').click(function() {
                // Here you can add additional logic for checking out, such as validating the order or redirecting to a checkout page
                alert('Checked Out.');

                // Loop through each row in the table body
                $('.t-body tr').each(function() {
                    const row = this;
                    const recordId = $(row).find('.delete-button').data('record-id'); // Get the record ID
                    const quantity = parseInt($(row).find('.qty-input').val(), 10); // Get the quantity
                    const subtotal = parseFloat($(row).find('.subtotal').text()); // Get the subtotal
                    updateDatabase(recordId, quantity, subtotal); // Call the updateDatabase function
                });
            });
  </script>
</html>